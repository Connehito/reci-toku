name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  # 変更検出ジョブ
  changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'packages/**'
              - 'pnpm-lock.yaml'
              - 'package.json'
              - 'turbo.json'
            web:
              - 'apps/web/**'
              - 'packages/**'
              - 'pnpm-lock.yaml'
              - 'package.json'
              - 'turbo.json'

  # Lint and Format チェック
  lint-and-format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 依存関係をインストール
        run: pnpm install --frozen-lockfile

      - name: Lint実行
        run: pnpm lint

      - name: Format確認
        run: pnpm format:check

  # APIテスト・ビルド
  test-api:
    needs: changes
    if: needs.changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 依存関係をインストール
        run: pnpm install --frozen-lockfile

      - name: APIテスト実行
        run: pnpm turbo run test --filter=api

      - name: APIカバレッジ計測
        run: pnpm --filter api test:cov

      - name: カバレッジレポートをアップロード
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-api
          path: apps/api/coverage/
          retention-days: 7

      - name: カバレッジサマリーをPRにコメント
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: github.event_name == 'pull_request'
        with:
          lcov-file: ./apps/api/coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          title: 'API カバレッジレポート'

      - name: APIビルド実行
        run: pnpm turbo run build --filter=api

  # Webテスト・ビルド
  test-web:
    needs: changes
    if: needs.changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 8.15.0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 依存関係をインストール
        run: pnpm install --frozen-lockfile

      - name: Webテスト実行
        run: pnpm turbo run test --filter=web

      - name: Webカバレッジ計測
        run: pnpm --filter web test:cov

      - name: カバレッジレポートをアップロード
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-web
          path: apps/web/coverage/
          retention-days: 7

      - name: カバレッジサマリーをPRにコメント
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: github.event_name == 'pull_request'
        with:
          lcov-file: ./apps/web/coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          title: 'Web カバレッジレポート'

      - name: Webビルド実行
        run: pnpm turbo run build --filter=web
