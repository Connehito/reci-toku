#!/bin/bash
# レシートリワード - Pre-commit Hook
# コミット前にセンシティブ情報をチェック

set -e

echo "🔍 センシティブ情報チェック中..."

# ステージングされたファイル一覧を取得（削除されたファイルは除外）
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

if [ -z "$STAGED_FILES" ]; then
  echo "✅ チェック対象ファイルなし"
  exit 0
fi

# チェック結果
HAS_ISSUES=0

# 1. .envファイルがステージングされていないかチェック
echo "  - .envファイルのチェック..."
if echo "$STAGED_FILES" | grep -E '^\.env$|^\.env\.local$|^\.env\.production$|secrets\.json|credentials\.json'; then
  echo "❌ エラー: センシティブな設定ファイルがステージングされています"
  echo "$STAGED_FILES" | grep -E '^\.env$|^\.env\.local$|^\.env\.production$|secrets\.json|credentials\.json'
  echo ""
  echo "対処方法:"
  echo "  git restore --staged <file>"
  HAS_ISSUES=1
fi

# 2. ステージングされたファイル内容をチェック（テストファイルは除外）
echo "  - APIキー・トークンのチェック..."
for FILE in $STAGED_FILES; do
  # テストファイルは除外
  if echo "$FILE" | grep -qE '\.(test|spec)\.(ts|js)$'; then
    continue
  fi

  # ファイルが存在し、テキストファイルの場合のみチェック
  if [ -f "$FILE" ] && file "$FILE" | grep -qE 'text|JSON|TypeScript|JavaScript'; then
    # APIキー・トークンのパターン
    if git diff --cached "$FILE" | grep -E '^\+.*["\047](AKIA[0-9A-Z]{16}|ghp_[a-zA-Z0-9]{36}|sk_live_[a-zA-Z0-9]+|pk_live_[a-zA-Z0-9]+)["\047]'; then
      echo "❌ エラー: APIキー・トークンが検出されました: $FILE"
      HAS_ISSUES=1
    fi

    # パスワードのハードコード（ただし変数名やコメントは除外）
    if git diff --cached "$FILE" | grep -E '^\+.*password\s*=\s*["\047][^"\047]{8,}["\047]' | grep -vE '(PASSWORD|process\.env|configService)'; then
      echo "❌ エラー: ハードコードされたパスワードが検出されました: $FILE"
      HAS_ISSUES=1
    fi

    # 秘密鍵
    if git diff --cached "$FILE" | grep -E '^\+.*-----BEGIN (RSA )?PRIVATE KEY-----'; then
      echo "❌ エラー: 秘密鍵が検出されました: $FILE"
      HAS_ISSUES=1
    fi

    # データベース接続文字列（パスワード付き）
    if git diff --cached "$FILE" | grep -E '^\+.*(mysql|postgres|mongodb)://[^:]+:[^@]+@'; then
      echo "❌ エラー: データベース接続文字列にパスワードが含まれています: $FILE"
      HAS_ISSUES=1
    fi
  fi
done

if [ $HAS_ISSUES -eq 1 ]; then
  echo ""
  echo "❌ センシティブ情報が検出されました。コミットを中止します。"
  echo ""
  echo "対処方法:"
  echo "  1. センシティブ情報を環境変数に移動"
  echo "  2. AWS Secrets Managerの使用を検討"
  echo "  3. git restore --staged <file> でステージングを解除"
  echo ""
  exit 1
fi

echo "✅ センシティブ情報チェック完了"
exit 0
